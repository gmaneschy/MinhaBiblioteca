<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Biblioteca</title>
<style>
body {
  font-family: 'Courier New', Courier, monospace;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 30px;
}

th, td {
  border: 1px solid #8b5e3c;
  padding: 10px;
  text-align: left;
}

th {
  background-color: #f4f4f4;
}

.btn {
  background-color: #8b5e3c;
  color: white;
  border: 1px solid #a67b5b;
  padding: 5px 14px;
  margin: 2px;
  border-radius: 5px;
  cursor: pointer;
  font-family: 'Courier New', Courier, monospace;
  text-decoration: none;

}

.btn:hover {
  background-color: #6b4226;
}

.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  font-family: 'Courier New', Courier, monospace;
}

.modal-conteudo {
  background: #fdf6e3;
  border: 3px solid #5d4037;
  padding: 20px;
  margin: 10% auto;
  width: 350px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.modal-conteudo label {
  display: block;
  margin-top: 10px;
}

.modal-conteudo input {
  width: 100%;
  padding: 6px;
  margin-top: 5px;
  border: 1px solid #a67b5b;
  border-radius: 4px;
  background-color: #fff8dc;
  font-family: 'Courier New', Courier, monospace;
}

.modal-conteudo button {
  margin-top: 15px;
}
</style>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/arquivo.css' %}">
</head>
<body>
    <div class="arquivo">
        <h1>Minha Biblioteca</h1>
        <div style="max-height: 70vh; overflow-y: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead style="position: sticky; top: 0; background-color: #e0e4cc; z-index: 1;">
              <tr>
                <th style="position: sticky; top: 0; background: #e0e4cc; z-index: 1;">Título</th>
                <th style="position: sticky; top: 0; background: #e0e4cc; z-index: 1;">Autor</th>
                <th style="position: sticky; top: 0; background: #e0e4cc; z-index: 1;">Editora</th>
                <th style="position: sticky; top: 0; background: #e0e4cc; z-index: 1;">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for livro in livros %}
              <tr data-id="{{ livro.id }}">
                <td>{{ livro.titulo }}</td>
                <td>{{ livro.autor }}</td>
                <td>{{ livro.editora }}</td>
                <td>
                    <a class="btn" onclick="abrirModal({{ livro.id }}, '{{ livro.titulo|escapejs }}', '{{ livro.autor|escapejs }}', '{{ livro.editora|escapejs }}')">Editar</a>
                    <a href="#" class="btn" onclick="excluirLivro({{ livro.id }}, this)">Excluir</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
        </table>
        </div>
    </div>


  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-conteudo">
      <form method="POST" action="{% url 'editar_livro' 0 %}" id="form-editar" onsubmit="salvarLivro(event)">
        {% csrf_token %}
        <input type="hidden" name="id" id="modal-id">
        <label for="modal-titulo">Título:</label>
        <input type="text" name="titulo" id="modal-titulo">
        <label for="modal-autor">Autor:</label>
        <input type="text" name="autor" id="modal-autor">
        <label for="modal-editora">Editora:</label>
        <input type="text" name="editora" id="modal-editora">
        <button type="submit" class="btn">Salvar</button>
        <button type="button" class="btn" onclick="fecharModal()">Cancelar</button>
      </form>
    </div>
  </div>

<script>
    function abrirModal(id, titulo, autor, editora) {
      document.getElementById('modal').style.display = 'block';
      document.getElementById('modal-id').value = id;
      document.getElementById('modal-titulo').value = titulo;
      document.getElementById('modal-autor').value = autor;
      document.getElementById('modal-editora').value = editora;

      const form = document.getElementById('form-editar');
      form.action = `/editar/${id}/`;
    }
</script>
<script>
    function fecharModal() {
      document.getElementById('modal').style.display = 'none';
    }
    window.onclick = function(event) {
      const modal = document.getElementById('modal');
      if (event.target === modal) {
        fecharModal();
      }
    }
</script>
<script>
    function validarFormulario() {
      const titulo = document.getElementById('modal-titulo').value.trim();
      const autor = document.getElementById('modal-autor').value.trim();
      const editora = document.getElementById('modal-editora').value.trim();

      if (!titulo || !autor || !editora) {
        alert('Por favor, preencha todos os campos.');
        return false;
      }
      return true;
    }
</script>
<script>
      function salvarLivro(event) {
    event.preventDefault();

    const id = document.getElementById('modal-id').value;
    const titulo = document.getElementById('modal-titulo').value;
    const autor = document.getElementById('modal-autor').value;
    const editora = document.getElementById('modal-editora').value;

    if (!validarFormulario()) return;

    fetch(`/editar/${id}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: new URLSearchParams({
        'titulo': titulo,
        'autor': autor,
        'editora': editora
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id) {
        const linha = document.querySelector(`tr[data-id='${data.id}']`);
        linha.children[0].textContent = data.titulo;
        linha.children[1].textContent = data.autor;
        linha.children[2].textContent = data.editora;
        fecharModal();
      } else {
        alert('Erro ao salvar');
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao salvar livro.');
    });
  }
</script>
<script>
function excluirLivro(id, botao) {
    if (!confirm("Tem certeza que deseja excluir este livro?")) return;

    fetch(`/deletar/${id}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        const linha = botao.closest('tr');
        linha.remove();
      } else {
        alert('Erro ao excluir livro');
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao excluir livro.');
    });
  }
</script>
</body>

</html>